!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Ballpen=e()}(this,function(){"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),n=function(){function n(e,i){t(this,n),this.init(e,i),this.scan(this.el)}return i(n,[{key:"init",value:function(t,e){var i=this;if(this.el=document.querySelector(t),this.el.style.display="none",!this.el)throw new Error("[Ballpen] Invalid root element!");if(this.dataModel=e,e.event&&(this.eventList={},this.initEventList(e.event)),e.data&&(this.dataListPure=e.data,this.dataList=n.clone(e.data),this.modelList={}),e.watchers){this.watchersHook=new Map;var r=e.watchers;for(var a in r){var o=a,s=r[a].handler;this.watchersHook.set(o,s)}this.watchersHook.forEach(function(t,e){n.renderObjectValueByPath(i.dataList,e,i.setProxy(n.parseData(e,i.dataList).data,e,t,t))})}this.registers=[],this.removedChildNodes=[]}},{key:"setProxy",value:function(t,e){var i=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o={get:function(t,r){return a&&a.call(i,n.parseData(e,i.dataListPure).data,n.parseData(e,i.dataList).data),t[r]},set:function(t,a,o,s){var l=void 0;return l=/^\$/gi.test(a)?a.substring(1):a,t[l]=o,l===a&&r&&r.call(i,n.parseData(e,i.dataListPure).data,n.parseData(e,i.dataList).data),!0},defineProperty:function(t,e,i){return Reflect.defineProperty(t,e,i)}};return new Proxy(t,o)}},{key:"initEventList",value:function(t){if(t){var e=t;for(var i in e)this.eventList[i]={},this.eventList[i].type="",this.eventList[i].fn=e[i]}}},{key:"scan",value:function(t){for(var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=0;i<t.children.length;i++){var n=t.children[i];if(n.hasAttributes()){for(var r=n.attributes,a=[],o=0;o<r.length;o++){var s=r.item(o);if(a.push(s.name),/bp-event:/gi.test(s.name)){var l=s.name.split(":")[1],c=s.value;this.bindEvent(n,c,l,this.dataList)}if(/bp-bind:/gi.test(s.name)){var u=s.name.split(":")[1],d=s.value;this.bindBind(n,d,u)}}if(a.includes("bp-for")){this.bindFor(n);continue}a.includes("bp-model")&&this.bindModel(n),a.includes("bp-class")&&this.bindClass(n),a.includes("bp-show")&&this.bindShow(n),/{{.*}}/gi.test(n.innerText)&&this.bindMoustache(n)}n.children.length>0&&this.scan(n,!1)}e&&(this.update(),this.attach(),this.el.style.removeProperty?this.el.style.removeProperty("display"):this.el.style.removeAttribute("display"))}},{key:"update",value:function(){this.removedChildNodes.forEach(function(t){t.remove()})}},{key:"bindShow",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=n.wrapAbsPath(i,t.getAttribute("bp-show"));n.ignoreInnerDirectives(r,[],function(t){var i=n.parseData(r,e.dataList),a=t.style;i.data?a.removeProperty?a.removeProperty("display"):a.removeAttribute("display"):a.display="none",e.register(e.dataList,e.dataListPure,i.path,function(t,e){e?a.removeProperty?a.removeProperty("display"):a.removeAttribute("display"):a.display="none"})},t)}},{key:"bindModel",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=n.wrapAbsPath(i,t.getAttribute("bp-model"));n.ignoreInnerDirectives(r,[/^@{([\d]+)}$/gi],function(t){if(/^@{([\d]+)}$/gi.test(r)){var i=r.match(/^@{([\d]+)}$/)[1];"INPUT"===t.tagName?t.value=i:t.innerText=i}else{var a=n.parseData(r,e.dataList);"INPUT"===t.tagName?t.value=a.data:t.innerText=a.data,e.register(e.dataList,e.dataListPure,a.path,function(e,i){"INPUT"===t.tagName?t.value=i:t.innerText=i})}},t)}},{key:"bindMoustache",value:function(t){}},{key:"bindClass",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=n.wrapAbsPath(i,t.getAttribute("bp-class"));n.ignoreInnerDirectives(r,[],function(t){var i=n.parseData(r,e.dataList);t.classList.contains(i.data)||t.classList.add(i.data),e.register(e.dataList,e.dataListPure,i.path,function(e,i){t.classList.remove(e),t.classList.contains(i)||t.classList.add(i)})},t)}},{key:"bindEvent",value:function(t,e,i,r){var a=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};n.ignoreInnerDirectives(e,[],function(t,e,i,n){a.eventList[e].type=i,t.addEventListener(i,function(){a.eventList[e].fn.call(a.dataList,t,n,o)})},t,e,i,r,o)}},{key:"bindBind",value:function(t,e,i){var r=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];n.ignoreInnerDirectives(e,[],function(t,e,i){var o=n.wrapAbsPath(a,e),s=n.parseData(o,r.dataList);t.setAttribute(i,s.data),r.register(r.dataList,r.dataListPure,s.path,function(e,n){t.setAttribute(i,n)})},t,e,i)}},{key:"bindFor",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};console.trace(i);var a=t.getAttribute("bp-for").split(/\s+in\s+/),o=a[1],s=a[0];if(/\./gi.test(o)){var l=o.split(".");i[o]=i[l[0]]+"."+l[1]}else i[o]=o;console.log(i),console.log(o),console.trace(i[o]);var c=n.parseData(i[o],this.dataList),u=t.parentNode;console.log(u);for(var d=document.createDocumentFragment(),h=0;h<c.data.length;h++){var f=t.cloneNode(!0),v=i[o]+"."+h;i[s]=v,r[s]=h,f.removeAttribute("bp-for"),this.bindForItemsRecursion(f,i,r,v,h,!0,function(t){d.appendChild(t)})}u.appendChild(d),console.log(r),this.register(this.dataList,this.dataListPure,c.path,function(n,a){for(var l=document.createDocumentFragment(),c=0;c<a.length;c++){var d=t.cloneNode(!0),h=i[o]+"."+c;i[s]=h,r[s]=c,e.bindForItemsRecursion(d,i,r,h,c,!0,function(t){l.appendChild(t)})}for(;u.firstChild;)u.removeChild(u.firstChild);u.appendChild(l)}),this.removedChildNodes.push(t)}},{key:"bindForItemsRecursion",value:function(t,e,i,r,a){for(var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=!!n.isHTMLCollection(t),c=0;c<(l?t.length:1);c++){var u=l?t[c]:t;if(u.hasAttributes()||!l){for(var d=u.attributes,h=[],f=0;f<d.length;f++){var v=d.item(f);if(h.push(v.name),/bp-event:/gi.test(v.name)){var p=v.name.split(":")[1],b=v.value;/^@:/gi.test(b)&&this.bindEvent(u,b.split(":")[1],p,this.dataList,{index:a})}}if(h.includes("bp-for"))console.log(111),this.bindFor(u,e,i);else{if(h.includes("bp-class")){var y=u.getAttribute("bp-class"),g=y;/^@/gi.test(y)&&(g=y.replace(/^@[a-z0-9A-Z_]*/,e[y.split(".")[0]])),g!==y&&u.setAttribute("bp-class",g),this.bindClass(u)}if(h.includes("bp-model")){var m=u.getAttribute("bp-model"),L=m;/^@/gi.test(m)&&(/\[\[index\]\]/gi.test(m)?(console.log(m),L="@{"+i[m.match(/^(.*)\[\[index\]\]$/)[1]]+"}"):L=m.replace(/^@[a-z0-9A-Z_]*/,e[m.split(".")[0]])),L!==m&&u.setAttribute("bp-model",L),this.bindModel(u)}if(h.includes("bp-show")){var P=u.getAttribute("bp-show"),A=P;/^@/gi.test(P)&&(A=P.replace(/^@[a-z0-9A-Z_]*/,e[P.split(".")[0]])),A!==P&&u.setAttribute("bp-show",A),this.bindShow(u)}u.children.length>0&&this.bindForItemsRecursion(u.children,e,i,r,a)}}else u.children.length>0&&this.bindForItemsRecursion(u.children,e,i,r,a)}o&&s&&s.call(this,t)}},{key:"observePath",value:function(t,e,i,r){var a=this;n.isArray(i)&&!function(){var n=t,o=void 0;i.forEach(function(t,e){/^\d+$/.test(t)&&(t=parseInt(t)),e<i.length-1?n=n[t]:o=t}),e=i.join("."),a.observeKey(n,e,o,r)}()}},{key:"observeKey",value:function(t,e,i){var r=this,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];n.isArray(i)?this.observePath(t,e,i,a):!function(){var o=t[i],s=e;n.isObject(o)?(Object.defineProperty(t,i,{get:function(){return o},set:function(t){t!==o&&(a&&a.forEach(function(e){e.call(r,o,t)}),o=t,n.renderObjectValueByPath(r.dataListPure,s,t))},enumerable:!0,configurable:!0}),Object.keys(o).forEach(function(t){r.observeKey(o,s+"."+t,t,a)})):n.isArray(o)?(Object.defineProperty(t,i,{get:function(){return o},set:function(t){t!==o&&(a&&a.forEach(function(e){e.call(r,o,t)}),o=t,n.renderObjectValueByPath(r.dataListPure,s,t))},enumerable:!0,configurable:!0}),r.observeArray(o,s,a)):Object.defineProperty(t,i,{get:function(){return o},set:function(t){t!==o&&(a&&a.forEach(function(e){e.call(r,o,t)}),o=t,n.renderObjectValueByPath(r.dataListPure,s,t))},enumerable:!0,configurable:!0})}()}},{key:"observeArray",value:function(t,e){var i=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=["copyWithin","fill","pop","push","reverse","shift","sort","splice","unshift"],o=Array.prototype,s=Object.create(o),l=e;a.forEach(function(e){Object.defineProperty(s,e,{enumerable:!0,configurable:!0,writable:!0,value:function(){for(var a,s=arguments.length,c=Array(s),u=0;u<s;u++)c[u]=arguments[u];var d=t.slice(),h=(a=o[e]).call.apply(a,[t].concat(c)),f=t;return n.renderObjectValueByPath(i.dataListPure,l,f),r&&r.forEach(function(t){t.call(i,d,f)}),h}})}),t.__proto__=s}},{key:"register",value:function t(e,i,n,r){var t=this.registers.find(function(t){if(Object.is(t.obj,e)&&(t.key===n||t.key.toString()===n.toString()))return t});t?t.fns.push(r):this.registers.push({obj:e,rootPath:[],key:n,fns:[r]})}},{key:"attach",value:function(){var t=this;this.registers.forEach(function(e){t.observeKey(e.obj,e.rootPath,e.key,e.fns)})}}],[{key:"isHTMLCollection",value:function(t){return"[object HTMLCollection]"===Object.prototype.toString.call(t)}},{key:"isArray",value:function(t){return Array.isArray(t)||"[object Array]"===Object.prototype.toString.call(t)}},{key:"isObject",value:function(t){return"[object Object]"===Object.prototype.toString.call(t)}},{key:"renderObjectValueByPath",value:function(t,e,i){var r=e.split(".");if("undefined"==typeof n.parseData(e,t).data)throw new Error('[Ballpen] "'+e+'" is an invalid watch path.');if(1===r.length)t[r[0]]=i;else for(var a=0;a<r.length-1;a++){if(t=t[r[a]],!t)throw new Error('[Ballpen] "'+e+'" is an invalid watch path.');a===r.length-2&&(t[r[r.length-1]]=i)}}},{key:"parseData",value:function(t,e){var i=t.split("."),n=e,r=[];return i.forEach(function(t,i){0===i?(n=e[t],r.push(t)):(n=n[t],r.push(t))}),{path:r,data:n}}},{key:"ignoreInnerDirectives",value:function(t,e,i){for(var n=arguments.length,r=Array(n>3?n-3:0),a=3;a<n;a++)r[a-3]=arguments[a];var o=this;e.forEach(function(e){e.test(t)&&i&&i.call.apply(i,[o].concat(r))}),/^@/gi.test(t)||i&&i.call.apply(i,[this].concat(r))}},{key:"clone",value:function(t){var i=void 0;if(null===t||"object"!==("undefined"==typeof t?"undefined":e(t)))return t;if(t instanceof Date)return i=new Date,i.setTime(t.getTime()),i;if(t instanceof Array){i=[];for(var r=0,a=t.length;r<a;r++)i[r]=n.clone(t[r]);return i}if(t instanceof Object){i={};for(var o in t)t.hasOwnProperty(o)&&(i[o]=n.clone(t[o]));return i}throw new Error("[Ballpen] Unable to copy object, type is not supported.")}},{key:"wrapAbsPath",value:function(t,e){return(n.isArray(t)&&t.length>0?t.join(".")+".":t.toString().length>0?t.toString()+".":"")+(n.isArray(e)&&e.length>0?e.join("."):e.toString().length>0?e.toString():"")}}]),n}();return n});
//# sourceMappingURL=ballpen.min.js.map
